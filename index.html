<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>白福利作品集 | Neo-Archive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+SC:wght@100..900&display=swap" rel="stylesheet">
  <style>
    :root{--primary-color:#fca5a5;--bg-dark:#121212;--text-light:#e0e0e0;}
    body{font-family:'Noto Sans SC','Inter',sans-serif;background:var(--bg-dark);color:var(--text-light);overflow-x:hidden;}
    .section-header{font-weight:700;letter-spacing:.1em;color:var(--primary-color);border-left:4px solid var(--primary-color);padding-left:1rem;margin-bottom:1.5rem;}
    .nav-link.active{background-color:rgba(252,165,165,.1);color:var(--primary-color);border-left:3px solid var(--primary-color);font-weight:600;}
    .look-card{border:1px solid rgba(252,165,165,.1);}
    .tech-spec-table th,.tech-spec-table td{padding:.5rem;border-bottom:1px solid #333;text-align:left;vertical-align:top;}
    .tech-spec-table th{color:var(--primary-color);width:30%}
    ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#202020}::-webkit-scrollbar-thumb{background:#555;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--primary-color)}

    /* 轮播：长边贴满，短边自适应 */
   .image-carousel{position:relative;cursor:pointer;overflow:hidden;border-radius:.5rem;transition:box-shadow.2s;display:flex;align-items:center;justify-content:center;}
   .image-carousel:hover{box-shadow:0 0 15px rgba(252,165,165,.3);}
   .carousel-image{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;filter:brightness(.9);transition:opacity.3s;}
   .carousel-nav-button{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:#fff;padding:.5rem .75rem;font-size:1.5rem;line-height:1;z-index:20;opacity:.7;transition:opacity .2s;border:none;cursor:pointer}
   .carousel-nav-button:hover{opacity:1;background:rgba(252,165,165,.6)}
   .carousel-counter{position:absolute;bottom:.5rem;right:.5rem;background:rgba(0,0,0,.6);color:#fff;padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem;z-index:20}
   .image-placeholder-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--text-light);font-weight:bold;background:rgba(0,0,0,.5);z-index:15;text-align:center;padding:.5rem}

.look-image-container{position:relative;height:50vh}
    section{scroll-margin-top:80px}
    @media(max-width:768px){.look-image-container{height:400px}}

    /* 管理按钮 */
   .carousel-manage-button{
      position:absolute;top:.5rem;left:.5rem;z-index:25;
background:rgba(0,0,0,.6);color:#fff;border:none;cursor:pointer;
      padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem;opacity:.8
    }
   .carousel-manage-button:hover{opacity:1;background:rgba(252,165,165,.6)}

    /* 管理面板 Modal（支持超长列表 + 拖拽排序 + 双击预览） */
   .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
   .modal{background:#1e1e1e;border:1px solid #333;border-radius:.75rem;max-width:1000px;width:94%;max-height:86vh;overflow:hidden;box-shadow:0 0 0 1px rgba(255,255,255,.04);display:flex;flex-direction:column}
   .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #333}
   .modal-title{font-weight:700}
   .modal-body{padding:1rem;overflow:auto;flex:1}
   .thumb-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.75rem}
   .thumb-card{border:1px solid #333;border-radius:.5rem;padding:.5rem;background:#141414;display:flex;flex-direction:column;gap:.5rem}
   .thumb-card.dragging{opacity:.6}
   .thumb-card.drag-over{outline:2px dashed #666}
   .thumb-card img{width:100%;height:120px;object-fit:contain;background:#0d0d0d;border-radius:.25rem;cursor:zoom-in}
   .btn{border:1px solid #444;background:#222;color:#e5e5e5;border-radius:.375rem;padding:.25rem .5rem;font-size:.75rem;cursor:pointer}
   .btn:hover{background:#333}
   .btn-danger{border-color:#6b2b2b;background:#3b1f1f}
   .btn-danger:hover{background:#512626}
   .modal-footer{display:flex;justify-content:space-between;gap:.5rem;padding:1rem;border-top:1px solid #333}

  .badge{font-size:.65rem;background:#2a2a2a;border:1px solid #444;padding:.1rem .4rem;border-radius:.25rem}
   .muted{color:#9ca3af;font-size:.8rem}

    /* 预览 Modal */
   .preview-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:60}
   .preview-box{max-width:92vw;max-height:90vh;display:flex;align-items:center;justify-content:center;position:relative}
   .preview-img{max-width:92vw;max-height:90vh;object-fit:contain}
   .preview-close{position:absolute;top:.75rem;right:.75rem;background:rgba(0,0,0,.6);color:#fff;border:none;border-radius:.375rem;padding:.25rem .5rem;cursor:pointer}

    /* 顶部工具条（仅编辑端显示） */
    #editor-toolbar{position:fixed;right:1rem;bottom:1rem;z-index:70;display:none}
    #toast{position:fixed;right:1rem;bottom:4.5rem;background:#1f2937;color:#fff;border:1px solid #374151;border-radius:.5rem;padding:.5rem .75rem;font-size:.875rem;display:none;z-index:80}
  </style>
</head>
<body class="antialiased">

  <input type="file" id="fileInput" accept="image/*" multiple class="hidden"/>

  <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-[#1e1e1e] p-6 shadow-2xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
    <h1 class="text-3xl font-bold mb-8 text-white tracking-widest border-b border-gray-700 pb-2">情绪 | PORTFOLIO</h1>
    <nav class="space-y-2">
      <a href="#concept" class="nav-link block p-3 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800">01. 核心策略与概念</a>
      <a href="#moodboard" class="nav-link block p-3 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800">02. 趋势与灵感解析</a>
      <a href="#lookbook" class="nav-link block p-3 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800">03. 核心 LOOKBOOK (18 Looks)</a>
      <a href="#tech-deep-dive" class="nav-link block p-3 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800">04. 设计深挖与技术规格</a>
      <a href="#ip-collab" class="nav-link block p-3 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800">05. IP 联名与营销企划</a>
      <a href="#conclusion" class="nav-link block p-3 rounded-lg text-sm text-gray-400 hover:text-white hover:bg-gray-800">06. 总结与未来展望</a>
    </nav>
  </aside>

  <div id="manager-backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="manager-title">
      <div class="modal-header">
        <div>
          <div id="manager-title" class="modal-title">图片管理</div>
          <div class="text-xs text-gray-400 mt-1">拖拽卡片可排序；双击缩略图可预览；“设为封面”会移动到首位。</div>
        </div>
        <button id="manager-close-x" class="btn" aria-label="关闭">✕</button>
      </div>
      <div class="modal-body">

    <div class="flex items-center justify-between mb-3">
          <div class="text-sm">位置：<span id="manager-slot-label" class="badge">-</span></div>
          <div id="manager-count" class="muted">共 0 张</div>
        </div>
        <div id="thumb-grid" class="thumb-grid"></div>
      </div>
      <div class="modal-footer">
        <div class="muted">提示：保存后生效；支持超过 10 张，滚动查看全部。</div>
        <div class="flex gap-2">
          <button id="manager-cancel" class="btn">取消</button>

         <button id="manager-save" class="btn" style="background:#2a2a2a;border-color:#555">保存顺序</button>
        </div>
      </div>
    </div>
  </div>

  <div id="preview-backdrop" class="preview-backdrop" aria-hidden="true">
    <div class="preview-box">
      <img id="preview-img" class="preview-img" src="" alt="预览"/>
      <button id="preview-close" class="preview-close">关闭</button>
    </div>
  </div>

  <div id="toast"></div>

  <div id="editor-toolbar" class="flex gap-2">
    <button id="save-site" class="btn">保存网站</button>
    <button id="share-site" class="btn">分享</button>
  </div>

  <div class="lg:ml-64 p-4 lg:p-10">
    <button id="menu-button" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-[#1e1e1e] rounded-md text-white" aria-label="切换侧栏">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/></svg>
    </button>

    <section id="concept" class="min-h-screen pt-20 lg:pt-0">
      <header class="mb-10 border-b border-gray-800 pb-4">
        <p class="text-lg text-gray-500">Chapter 01</p>
        <h2 class="text-5xl font-extrabold text-white">核心策略与概念</h2>
      </header>

      <div class="space-y-8 max-w-4xl">
        <div class="bg-[#1e1e1e] p-6 rounded-xl shadow-lg border border-gray-700">
          <h3 class="text-2xl font-semibold mb-3 text-white">主题定义：Neo-Archive</h3>
          <p class="text-gray-400">将<strong>复古的怀旧肌理（Archive）</strong>与<strong>创新功能及情绪化设计（Neo）</strong>结合，打造高话题且可量产的产品线。</p>
        </div>

        <h3 class="text-xl section-header">三大设计支柱 (Three Pillars)</h3>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="p-4 bg-gray-900 rounded-lg border-t-4 border-red-400"><p class="font-bold text-red-400">Archive Texture</p><p class="text-sm text-gray-400 mt-1">擦色PU、麂皮绒、重水洗丹宁。</p></div>
          <div class="p-4 bg-gray-900 rounded-lg border-t-4 border-cyan-400"><p class="font-bold text-cyan-400">Neo-Tech</p><p class="text-sm text-gray-400 mt-1">可变结构、通风与轻量。</p></div>
          <div class="p-4 bg-gray-900 rounded-lg border-t-4 border-yellow-400"><p class="font-bold text-yellow-400">Emotion Focus</p><p class="text-sm text-gray-400 mt-1">强符号辅料与社媒传播。</p></div>
        </div>
      </div>
    </section>

    <section id="moodboard" class="min-h-screen pt-20">
      <header class="mb-10 border-b border-gray-800 pb-4">
        <p class="text-lg text-gray-500">Chapter 02</p>
        <h2 class="text-5xl font-extrabold text-white">趋势与灵感解析</h2>
      </header>

      <h3 class="text-xl section-header">Moodboard: Neo-Archive Aesthetics</h3>
      <div id="moodboard-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12"></div>

      <h3 class="text-xl section-header">核心色彩体系 (Core Color Palette)</h3>
      <div class="grid grid-cols-3 md:grid-cols-6 gap-4 max-w-4xl">
        <div class="p-4 rounded-lg bg-gray-800 text-center"><div class="w-full h-12 rounded-lg mb-2"></div><p class="text-sm">藏青 / 沉稳底色</p></div>
        <div class="p-4 rounded-lg bg-gray-800 text-center"><div class="w-full h-12 rounded-lg mb-2"></div><p class="text-sm">米白 / 清晰轮廓</p></div>
        <div class="p-4 rounded-lg bg-gray-800 text-center"><div class="w-full h-12 rounded-lg bg-[#5C4033] mb-2"></div><p class="text-sm">咖棕 / 复古肌理</p></div>
        <div class="p-4 rounded-lg bg-gray-800 text-center"><div class="w-full h-12 rounded-lg bg-[#800020] mb-2"></div><p class="text-sm">勃艮第红 / 情感强调</p></div>
        <div class="p-4 rounded-lg bg-gray-800 text-center"><div class="w-full h-12 rounded-lg mb-2"></div><p class="text-sm">赛博蓝 / 科技点缀</p></div>
        <div class="p-4 rounded-lg bg-gray-800 text-center"><div class="w-full h-12 rounded-lg bg-[#000000] mb-2 border border-gray-700"></div><p class="text-sm">玄黑 / 街头基调</p></div>
      </div>
    </section>

    <section id="lookbook" class="pt-20">
      <header class="mb-10 border-b border-gray-800 pb-4">
        <p class="text-lg text-gray-500">Chapter 03</p>
        <h2 class="text-5xl font-extrabold text-white">核心 LOOKBOOK</h2>
      </header>
      <div id="lookbook-container" class="grid md:grid-cols-2 gap-8"></div>
    </section>

    <section id="tech-deep-dive" class="pt-20 min-h-screen">
      <header class="mb-10 border-b border-gray-800 pb-4">
        <p class="text-lg text-gray-500">Chapter 04</p>
        <h2 class="text-5xl font-extrabold text-white">设计深挖与技术规格</h2>
      </header>

      <h3 class="text-xl section-header">SKU 1: 复古-羊毛内里擦色PU夹克外套</h3>
      <div class="bg-[#1e1e1e] p-6 rounded-xl border border-gray-700 mb-8">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div id="tech-sku1-img1-wrapper" class="col-span-1 image-carousel" data-target-id="tech-sku1-img1" style="height:250px;">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('tech-sku1-img1')">管理</button>
            <img id="tech-sku1-img1" src="uploaded:复古-羊毛内里擦色PU夹克外套.zip/复古-羊毛内里擦色PU夹克外套/复古-羊毛内里擦色PU夹克外套咖色正反面.jpg" alt="PU夹克平面图" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/333/fff?text=点击导入SKU+1+平面图';"/>
            <div id="tech-sku1-img1-placeholder" class="image-placeholder-text">点击导入SKU 1 平面图</div>
            <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('tech-sku1-img1')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('tech-sku1-img1')">»</button>
            <span id="tech-sku1-img1-counter" class="carousel-counter">1/1</span>
          </div>
          <div id="tech-sku1-img2-wrapper" class="col-span-2 image-carousel" data-target-id="tech-sku1-img2" style="height:250px;">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('tech-sku1-img2')">管理</button>
            <img id="tech-sku1-img2" src="uploaded:复古-羊毛内里擦色PU夹克外套.zip/复古-羊毛内里擦色PU夹克外套/复古-羊毛内里擦色PU夹克外套咖色背面细节.jpg" alt="PU夹克细节" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/333/fff?text=点击导入SKU+1+细节图';"/>
            <div id="tech-sku1-img2-placeholder" class="image-placeholder-text">点击导入SKU 1 细节图</div>
            <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('tech-sku1-img2')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('tech-sku1-img2')">»</button>
            <span id="tech-sku1-img2-counter" class="carousel-counter">1/1</span>
          </div>
        </div>
      </div>

      <h3 class="text-xl section-header">SKU 2: 情绪 -杜宾帽子卫衣开衫</h3>
      <div class="bg-[#1e1e1e] p-6 rounded-xl border border-gray-700 mb-8">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div id="tech-sku2-img1-wrapper" class="col-span-1 image-carousel" data-target-id="tech-sku2-img1" style="height:250px;">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('tech-sku2-img1')">管理</button>
            <img id="tech-sku2-img1" src="uploaded:情绪 -杜宾帽子卫衣开衫.zip/情绪 -杜宾帽子卫衣开衫/情绪 -杜宾帽子卫衣开衫正面.png" alt="杜宾卫衣平面图" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/333/fff?text=点击导入SKU+2+平面图';"/>
            <div id="tech-sku2-img1-placeholder" class="image-placeholder-text">点击导入SKU 2 平面图</div>
            <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('tech-sku2-img1')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('tech-sku2-img1')">»</button>
            <span id="tech-sku2-img1-counter" class="carousel-counter">1/1</span>
          </div>
          <div id="tech-sku2-img2-wrapper" class="col-span-2 image-carousel" data-target-id="tech-sku2-img2" style="height:250px;">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('tech-sku2-img2')">管理</button>
            <img id="tech-sku2-img2" src="uploaded:情绪 -杜宾帽子卫衣开衫.zip/情绪 -杜宾帽子卫衣开衫/情绪 -杜宾帽子卫衣开衫耳朵细节.png" alt="杜宾耳朵细节" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/333/fff?text=点击导入SKU+2+细节图';"/>
            <div id="tech-sku2-img2-placeholder" class="image-placeholder-text">点击导入SKU 2 细节图</div>
            <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('tech-sku2-img2')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('tech-sku2-img2')">»</button>
            <span id="tech-sku2-img2-counter" class="carousel-counter">1/1</span>
          </div>
        </div>
      </div>

      <h3 class="text-xl section-header">SKU 3: 复古-织带拼接大口袋牛仔裤</h3>
      <div class="bg-[#1e1e1e] p-6 rounded-xl border border-gray-700">
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div id="tech-sku3-img1-wrapper" class="col-span-1 image-carousel" data-target-id="tech-sku3-img1" style="height:250px;">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('tech-sku3-img1')">管理</button>
            <img id="tech-sku3-img1" src="uploaded:复古-织带拼接大口袋牛仔裤.zip/复古-织带拼接大口袋牛仔裤/复古-织带拼接大口袋牛仔裤正面图.jpg" alt="牛仔裤平面图" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/333/fff?text=点击导入SKU+3+平面图';"/>
            <div id="tech-sku3-img1-placeholder" class="image-placeholder-text">点击导入SKU 3 平面图</div>
            <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('tech-sku3-img1')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('tech-sku3-img1')">»</button>
            <span id="tech-sku3-img1-counter" class="carousel-counter">1/1</span>
          </div>
          <div id="tech-sku3-img2-wrapper" class="col-span-2 image-carousel" data-target-id="tech-sku3-img2" style="height:250px;">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('tech-sku3-img2')">管理</button>
            <img id="tech-sku3-img2" src="uploaded:复古-织带拼接大口袋牛仔裤.zip/复古-织带拼接大口袋牛仔裤/复古-织带拼接大口袋牛仔裤模特图女.jpg" alt="牛仔裤细节" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/333/fff?text=点击导入SKU+3+细节图';"/>
            <div id="tech-sku3-img2-placeholder" class="image-placeholder-text">点击导入SKU 3 细节图</div>
            <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('tech-sku3-img2')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('tech-sku3-img2')">»</button>
            <span id="tech-sku3-img2-counter" class="carousel-counter">1/1</span>
          </div>
        </div>
      </div>
    </section>

    <section id="ip-collab" class="pt-20 min-h-screen">
      <header class="mb-10 border-b border-gray-800 pb-4">
        <p class="text-lg text-gray-500">Chapter 05</p>
        <h2 class="text-5xl font-extrabold text-white">IP 联名与营销企划</h2>
      </header>

      <div class="bg-[#1e1e1e] p-6 rounded-xl border border-gray-700 mb-8 max-w-4xl">
        <h3 class="text-2xl font-semibold mb-4 text-cyan-400">IP 案例：Neo-Tom & Jerry 联名企划</h3>
        <div id="ip-collab-img-wrapper" class="image-carousel w-full" data-target-id="ip-collab-img" style="height:400px;">
          <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('ip-collab-img')">管理</button>
          <img id="ip-collab-img" src="uploaded:联名-猫和老鼠米粒绣卫衣开衫.zip/联名-猫和老鼠米粒绣卫衣开衫/联名-猫和老鼠米粒绣卫衣开衫齐色.jpg" alt="联名主视觉" class="carousel-image" onerror="this.onerror=null;this.src='https://placehold.co/600x400/333/fff?text=点击导入IP联名主视觉图';"/>
          <div id="ip-collab-img-placeholder" class="image-placeholder-text">点击导入IP联名主视觉图</div>
          <button class="carousel-nav-button left-0 rounded-r-lg" onclick="event.stopPropagation(); prevImage('ip-collab-img')">«</button>
          <button class="carousel-nav-button right-0 rounded-l-lg" onclick="event.stopPropagation(); nextImage('ip-collab-img')">»</button>
          <span id="ip-collab-img-counter" class="carousel-counter">1/1</span>
        </div>
      </div>
    </section>

    <section id="conclusion" class="pt-20 pb-20 min-h-screen">
      <header class="mb-10 border-b border-gray-800 pb-4">
        <p class="text-lg text-gray-500">Chapter 06</p>
        <h2 class="text-5xl font-extrabold text-white">总结与未来展望</h2>
      </header>
      <div class="bg-[#1e1e1e] p-6 rounded-xl border border-gray-700 max-w-4xl">
        <h3 class="text-2xl font-semibold mb-4 text-red-400">核心价值总结：T-C-I 模型</h3>
        <p class="text-gray-400 mb-6">将<strong>趋势（Trend）</strong>转为<strong>商业（Commercial）</strong>并实现<strong>创新（Innovation）</strong>。</p>
      </div>
    </section>
  </div>

  <script>
    // —— 模式与工具条可见性 ——
    const qs = new URLSearchParams(location.search);
    const mode = (qs.get('mode') || 'edit').toLowerCase();
    const isView = mode === 'view';

    // —— 数据与状态 ——
    const looksData = [];
    const imageGalleries = {}; // { slotId: { urls:[], current:0 } }
    let currentTargetImgId = null;
    const moodboardSlots = [
      { id:'mood-slot-1', content:'擦色PU肌理 / 重水洗丹宁' },
      { id:'mood-slot-2', content:'户外功能结构 / 轻薄尼龙' },
      { id:'mood-slot-3', content:'杜宾符号 / 小恶魔角 / 拟型刺绣' },
      { id:'mood-slot-4', content:'运动条纹 / 麂皮绒 / 赛博感眼镜' }
    ];

    // ====== 云端 API 配置和读写函数 (跨设备共享核心) ======

    // 替换为你的 JSONBin.io Master Key（不要把 key 发到公开场合）
    const API_URL = 'https://api.jsonbin.io/v3/b';
    const MASTER_KEY = '$2a$10$mpnSH84JYH1WdrRZ6DT15OLxO7Oj.JwYcC93VOa4d5tWuLt5AAFia'; // <-- 在本地替换为你的 key
    const API_HEADERS = {
        'Content-Type': 'application/json',
        'X-Master-Key': MASTER_KEY,
        'X-Bin-Meta-By-User': 'false',
    };

    async function postSnapshot(snapshotData) {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: API_HEADERS,
            body: JSON.stringify(snapshotData),
        });
        if (!response.ok) {
            throw new Error(`API save failed: ${response.status} ${response.statusText}`);
        }
        const result = await response.json();
        return result.metadata && result.metadata.id ? result.metadata.id : (result.id || '');
    }

    async function fetchSnapshot(snapshotId) {
        const READ_URL = `${API_URL}/${snapshotId}/latest`;
        const response = await fetch(READ_URL);
        if (!response.ok) {
            throw new Error(`Snap ID ${snapshotId} not found (Status: ${response.status})`);
        }
        const result = await response.json();
        return result.record || {};
    }

    // —— 通用工具：Toast / 复制 / 本地存储 / 快照 ——
    function toastEl(){ return document.getElementById('toast'); }
    function showToast(msg, ms=2200){
      const t = toastEl();
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(showToast._tid);
      showToast._tid = setTimeout(()=>{t.style.display='none';}, ms);
    }
    async function copyText(text){
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      try{
        const ta=document.createElement('textarea');
        ta.value=text; ta.readOnly=true; ta.style.position='fixed'; ta.style.opacity='0';
        document.body.appendChild(ta); ta.select();
        const ok=document.execCommand('copy'); document.body.removeChild(ta);
        return ok;
      }catch(e){ return false; }
    }

    const SNAPKEY='neoArchiveSnaps';
    function loadAllSnapshots(){
      try{ return JSON.parse(localStorage.getItem(SNAPKEY)||'{}'); }catch(e){ return {}; }
    }
    function saveAllSnapshots(obj){
      localStorage.setItem(SNAPKEY, JSON.stringify(obj));
    }
    function genId(){ return 's'+Math.random().toString(36).slice(2,10)+Date.now().toString(36); }

    // 将页面上每个槽位<img>的当前 src 同步进 imageGalleries
    function syncFromDOM(){
      document.querySelectorAll('.image-carousel').forEach(wrap=>{
        const slotId = wrap.getAttribute('data-target-id');
        if(!slotId) return;
        const img = document.getElementById(slotId);
        if(!img) return;
        const src = img.getAttribute('src') || '';
        if(!imageGalleries[slotId]) imageGalleries[slotId] = { urls:[], current:0 };
        const g = imageGalleries[slotId];
        if (src) {
            if (!g.urls || g.urls.length === 0) {
                g.urls = [src];
                g.current = 0;
            } else if (g.urls[g.current] !== src) {
                g.urls[g.current] = src;
            }
        }
      });
    }

    function createSnapshot(){
      const galleries = {};
      Object.keys(imageGalleries).forEach(k=>{
        const g=imageGalleries[k]; if(!g) return;
        galleries[k] = { urls:[...g.urls], current: g.current||0 };
      });
      return { galleries, ts: Date.now() };
    }
    function applySnapshot(snap){
      if(!snap || !snap.galleries) return;
      Object.keys(snap.galleries).forEach(k=>{
        const g=snap.galleries[k];
        imageGalleries[k] = { urls:[...g.urls], current:g.current||0 };
        const wrap=document.getElementById(`${k}-wrapper`);
        if(wrap){ updateCarousel(k); }
      });
    }

    // —— 画廊基础逻辑 ——
    function initializeGallery(slotId, initialSrcAttr){
      if(!imageGalleries[slotId]) imageGalleries[slotId]={urls:[],current:0};
      const ph=document.getElementById(`${slotId}-placeholder`);
      if(initialSrcAttr && !initialSrcAttr.startsWith('data:')){
        imageGalleries[slotId].urls=[initialSrcAttr];
        if(ph) ph.classList.add('hidden');
      }else{
        if(ph) ph.classList.remove('hidden');
      }
      updateCarousel(slotId);
    }
    function updateCarousel(slotId){
      const g=imageGalleries[slotId];
      const img=document.getElementById(slotId);
      const wrapper=document.getElementById(`${slotId}-wrapper`);
      if(!img||!wrapper) return;
      const ph=document.getElementById(`${slotId}-placeholder`)||wrapper.querySelector('.image-placeholder-text');
      const counter=wrapper.querySelector('.carousel-counter');
      const navBtns=wrapper.querySelectorAll('.carousel-nav-button');

      if(!g||!g.urls||g.urls.length===0){
        img.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
        if(ph) ph.classList.remove('hidden');
        if(counter) counter.classList.add('hidden');
        navBtns.forEach(b=>b.classList.add('hidden'));
        return;
      }
      if(ph) ph.classList.add('hidden');

      if(g.current>=g.urls.length) g.current=g.urls.length-1;
      if(g.current<0) g.current=0;

      img.src=g.urls[g.current];
      if(g.urls.length>1){
        navBtns.forEach(b=>b.classList.remove('hidden'));
        if(counter){counter.classList.remove('hidden');counter.textContent=`${g.current+1}/${g.urls.length}`;}
      }else{
        navBtns.forEach(b=>b.classList.add('hidden'));
        if(counter) counter.classList.add('hidden');
      }
    }
    window.prevImage=function(slotId){const g=imageGalleries[slotId];if(g&&g.urls&&g.urls.length>1){g.current=(g.current-1+g.urls.length)%g.urls.length;updateCarousel(slotId);}}
    window.nextImage=function(slotId){const g=imageGalleries[slotId];if(g&&g.urls&&g.urls.length>1){g.current=(g.current+1)%g.urls.length;updateCarousel(slotId);}}

    // —— 图片管理（排序 + 拖拽 + 预览）——
    let managerSlotId=null;
    const backdrop=()=>document.getElementById('manager-backdrop');
    const countEl=()=>document.getElementById('manager-count');

    function openManager(slotId){
      if(isView) return;
      managerSlotId=slotId;
      document.getElementById('manager-slot-label').textContent=slotId;
      renderManagerList();
      backdrop().style.display='flex';
      backdrop().setAttribute('aria-hidden','false');
    }
    function closeManager(save=false){
      if(save && managerSlotId){ updateCarousel(managerSlotId); }
      managerSlotId=null;
      backdrop().style.display='none';
      backdrop().setAttribute('aria-hidden','true');
    }
    function renderManagerList(){
      const grid=document.getElementById('thumb-grid');
      grid.innerHTML='';
      const g=imageGalleries[managerSlotId] || { urls: [] };
      countEl().textContent=`共 ${g.urls.length} 张`;
      if(g.urls.length===0){
        grid.innerHTML='<div class="text-sm text-gray-400">暂无图片，请在占位符处点击导入。</div>';
        return;
      }
      g.urls.forEach((u,idx)=>{
        const card=document.createElement('div');
        card.className='thumb-card';
        card.setAttribute('draggable','true');
        card.dataset.index=idx;

        card.addEventListener('dragstart',(e)=>{ card.classList.add('dragging'); e.dataTransfer.setData('text/plain', String(idx)); });
        card.addEventListener('dragend',()=>card.classList.remove('dragging'));
        card.addEventListener('dragover',(e)=>{e.preventDefault(); card.classList.add('drag-over');});
        card.addEventListener('dragleave',()=>card.classList.remove('drag-over'));
        card.addEventListener('drop',(e)=>{ e.preventDefault(); card.classList.remove('drag-over');
          const from=Number(e.dataTransfer.getData('text/plain')); const to=Number(card.dataset.index);
          moveAbsolute(managerSlotId, from, to);
        });

        const img=document.createElement('img');
        img.src=u; img.alt=`thumb-${idx}`;
        img.addEventListener('dblclick',()=>openPreview(u));
        const row=document.createElement('div');
        row.className='flex items-center justify-between gap-1';

        const left=document.createElement('div');
        left.className='flex items-center gap-1';
        const up=document.createElement('button'); up.className='btn'; up.textContent='上移'; up.onclick=()=>moveItem(managerSlotId,idx,-1);
        const down=document.createElement('button'); down.className='btn'; down.textContent='下移'; down.onclick=()=>moveItem(managerSlotId,idx,1);
        const cover=document.createElement('button'); cover.className='btn'; cover.textContent='设为封面'; cover.onclick=()=>setCover(managerSlotId,idx);
        left.append(up,down,cover);

        const right=document.createElement('div');
        const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='删除'; del.onclick=()=>removeItem(managerSlotId,idx);
        right.append(del);

        const idxBadge=document.createElement('div');
        idxBadge.className='text-xs text-gray-400';
        idxBadge.textContent=`序号：${idx+1}`;

        card.append(img,idxBadge,row);
        row.prepend(left);
        row.append(right);
        grid.append(card);
      });
    }
    function moveAbsolute(slotId, from, to){
      const g=imageGalleries[slotId];
      if(!g) return;
      if(from===to) return;
      const item=g.urls.splice(from,1)[0];
      g.urls.splice(to,0,item);
      if(g.current===from) g.current=to;
      else if(from<g.current && to>=g.current) g.current--;
      else if(from>g.current && to<=g.current) g.current++;
      renderManagerList();
    }
    function moveItem(slotId,idx,delta){
      const g=imageGalleries[slotId]; if(!g) return;
      const newIdx=idx+delta;
      if(newIdx<0||newIdx>=g.urls.length) return;
      [g.urls[idx],g.urls[newIdx]]=[g.urls[newIdx],g.urls[idx]];
      if(g.current===idx) g.current=newIdx;
      else if(g.current===newIdx) g.current=idx;
      renderManagerList();
    }
    function removeItem(slotId,idx){
      const g=imageGalleries[slotId];
      if(!g) return;
      g.urls.splice(idx,1);
      if(g.current>=g.urls.length) g.current=g.urls.length-1;
      if(g.current<0) g.current=0;
      renderManagerList();
    }
    function setCover(slotId,idx){
      const g=imageGalleries[slotId];
      if(!g) return;
      const [v]=g.urls.splice(idx,1);
      g.urls.unshift(v);
      g.current=0;
      renderManagerList();
    }

    // 预览
    function openPreview(src){
      const bd=document.getElementById('preview-backdrop');
      const img=document.getElementById('preview-img');
      img.src=src;
      bd.style.display='flex';
      bd.setAttribute('aria-hidden','false');
    }
    function closePreview(){
      const bd=document.getElementById('preview-backdrop');
      const img=document.getElementById('preview-img');
      img.src='';
      bd.style.display='none';
      bd.setAttribute('aria-hidden','true');
    }

    // 渲染 Moodboard
    function renderMoodboard(){
      const container=document.getElementById('moodboard-container');container.innerHTML='';
      moodboardSlots.forEach((slot,idx)=>{
        const imgId=`mood-img-${idx}`;
        const wrapper=document.createElement('div');
        wrapper.id=`${imgId}-wrapper`;
        wrapper.className='aspect-square bg-gray-700 relative image-carousel';
        wrapper.setAttribute('data-target-id',imgId);

        const manage=document.createElement('button');
        manage.className='carousel-manage-button';
        manage.textContent='管理';
        manage.onclick=(e)=>{e.stopPropagation();openManager(imgId);};

        const img=document.createElement('img');
        img.id=imgId;
        img.className='carousel-image';
        img.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

        const ph=document.createElement('div');
        ph.id=`${imgId}-placeholder`;
        ph.className='image-placeholder-text rounded-lg text-sm p-4';
        ph.innerHTML=`${slot.content}<br>(点击导入多张图片)`;

        const prev=document.createElement('button');
        prev.className='carousel-nav-button left-0 rounded-r-lg hidden';
        prev.innerHTML='«';
        prev.onclick=(e)=>{e.stopPropagation();prevImage(imgId);};

        const next=document.createElement('button');
        next.className='carousel-nav-button right-0 rounded-l-lg hidden';
        next.innerHTML='»';
        next.onclick=(e)=>{e.stopPropagation();nextImage(imgId);};

        const counter=document.createElement('span');
        counter.id=`${imgId}-counter`;
        counter.className='carousel-counter hidden';
        counter.textContent='0/0';
        wrapper.append(manage,img,ph,prev,next,counter);
        container.append(wrapper);

        initializeGallery(imgId,img.getAttribute('src'));
      });
    }

    // 全局点击：打开文件对话框（展示端禁用）
    document.addEventListener('click',(e)=>{
      if(isView) return;
      const navBtn=e.target.closest('.carousel-nav-button'); if(navBtn) return;
      const manageBtn=e.target.closest('.carousel-manage-button'); if(manageBtn) return;
      const wrapper=e.target.closest('.image-carousel'); if(!wrapper) return;
      const imgId=wrapper.getAttribute('data-target-id'); if(!imgId) return;
      currentTargetImgId=imgId;
      document.getElementById('fileInput').click();
    });

    // 初始化
    document.addEventListener('DOMContentLoaded',()=>{
      const lookbookContainer=document.getElementById('lookbook-container');
      const sections=document.querySelectorAll('section');
      const navLinks=document.querySelectorAll('.nav-link');
      const sidebar=document.getElementById('sidebar');
      const menuButton=document.getElementById('menu-button');
      const fileInput=document.getElementById('fileInput');

      // 编辑工具条显示控制
      const toolbar = document.getElementById('editor-toolbar');
      if(!isView){ toolbar.style.display='flex'; }
      // 展示端隐藏所有管理按钮
      if(isView){
        document.documentElement.classList.add('view-mode');
        const css = document.createElement('style');
        css.textContent = `.carousel-manage-button{display:none!important}`;
        document.head.appendChild(css);
      }

      // Moodboard
      renderMoodboard();

      // Lookbook 卡片
      looksData.forEach(look=>{
        const imgId=`look-img-${look.id}`;
        const card=document.createElement('div');
        card.className='look-card p-4 rounded-xl flex flex-col md:flex-row bg-[#1e1e1e] hover:shadow-lg transition-shadow duration-300';
        card.innerHTML=`
          <div id="${imgId}-wrapper" class="look-image-container md:w-3/5 rounded-lg overflow-hidden mb-4 md:mb-0 md:mr-4 image-carousel" data-target-id="${imgId}">
            <button class="carousel-manage-button" onclick="event.stopPropagation(); openManager('${imgId}')">管理</button>
            <img id="${imgId}" src="${look.img || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="${look.title}" class="carousel-image"
                 onerror="this.onerror=null;this.src='https://placehold.co/800x800/800020/fff?text=点击导入+LOOK+${look.id}+图片'">
            <div id="${imgId}-placeholder" class="image-placeholder-text">点击导入LOOK ${look.id} 图片 (支持多张)</div>
            <button class="carousel-nav-button left-0 rounded-r-lg hidden" onclick="event.stopPropagation(); prevImage('${imgId}')">«</button>
            <button class="carousel-nav-button right-0 rounded-l-lg hidden" onclick="event.stopPropagation(); nextImage('${imgId}')">»</button>
            <span id="${imgId}-counter" class="carousel-counter hidden">1/1</span>
          </div>
          <div class="md:w-2/5 p-2 border-l border-gray-700 md:pl-6 space-y-4">
            <p class="text-xs font-bold uppercase tracking-wider ${look.color || ''}">${(look.theme||'') } / Look ${look.id}</p>
            <h4 class="text-2xl font-bold text-white leading-tight">${look.title || ''}</h4>
            <table class="w-full text-xs text-gray-400 space-y-2">
              <tr><th class="text-white pt-2 w-1/3">核心SKU</th><td class="pt-2">${look.sku || ''}</td></tr>
              <tr><th class="text-white pt-2">设计语言</th><td class="pt-2">${look.design || ''}</td></tr>
              <tr><th class="text-white pt-2">廓形策略</th><td class="pt-2">${look.shape || ''}</td></tr>
              <tr><th class="text-white pt-2">商业潜力</th><td class="pt-2">${look.business || ''}</td></tr>
            </table>
          </div>`;
        lookbookContainer.appendChild(card);

        const initialAttr=card.querySelector(`#${imgId}`).getAttribute('src');
        initializeGallery(imgId,initialAttr);
      });

      // 滚动高亮
      const observer=new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            navLinks.forEach(l=>l.classList.remove('active'));
            const id=entry.target.id;
            const el=document.querySelector(`.nav-link[href="#${id}"]`);
            if(el) el.classList.add('active');
          }
        });
      },{threshold:0.5});
      sections.forEach(s=>observer.observe(s));

      // 导航与侧栏
      navLinks.forEach(link=>{
        link.addEventListener('click',(e)=>{
          e.preventDefault();
          const target=document.querySelector(link.getAttribute('href'));
          if(target) target.scrollIntoView({behavior:'smooth'});
          if(window.innerWidth<1024) sidebar.classList.add('-translate-x-full');
        });
      });
      menuButton.addEventListener('click',()=>sidebar.classList.toggle('-translate-x-full'));

      // Tech 与 IP 初始图接入画廊
      document.querySelectorAll('.image-carousel[data-target-id^="tech-sku"]').forEach(wrap=>{
        const imgId=wrap.getAttribute('data-target-id');
        const initialAttr=wrap.querySelector(`#${imgId}`).getAttribute('src');
        initializeGallery(imgId,initialAttr);
      });
      const ipWrap=document.getElementById('ip-collab-img-wrapper');
      if(ipWrap){
        const imgId=ipWrap.getAttribute('data-target-id');
        const initialAttr=ipWrap.querySelector(`#${imgId}`).getAttribute('src');
        initializeGallery(imgId,initialAttr);
      }

      // 多文件导入（展示端禁用）
      fileInput.addEventListener('change',(e)=>{
        if(isView) return;
        const files=e.target.files;
        if(!files.length||!currentTargetImgId) return;
        const slotId=currentTargetImgId;
        const g=imageGalleries[slotId];
        if(!g) return;
        g.urls=[]; g.current=0;
        let loaded=0;
        Array.from(files).forEach(f=>{
          const r=new FileReader();
          r.onload=ev=>{
            g.urls.push(ev.target.result);
            loaded++;
            if(loaded===files.length){
              updateCarousel(slotId);
              currentTargetImgId=null;
              e.target.value='';
            }
          };
          r.readAsDataURL(f);
        });
      });
      fileInput.addEventListener('cancel',()=>{ currentTargetImgId=null; });

      // —— 快照加载：若带 id 参数则尝试云端加载，失败则回退本地 ——

      const id = qs.get('id');
      if (id) {
          showToast('正在加载云端快照，请稍候...');
          (async () => {
              try {
                  const remoteData = await fetchSnapshot(id); // 尝试云端 GET
                  applySnapshot(remoteData);
                  showToast('云端快照加载成功！');
              } catch (e) {
                  console.error('Remote load error:', e);
                  const all = loadAllSnapshots();
                  if (all[id]) {
                      applySnapshot(all[id]);
                      showToast('云端加载失败，已切换至本地快照。');
                  } else {
                      showToast('加载失败，未找到该分享ID对应的快照。', 5000);
                  }
              }
          })();
      } else {
        const all = loadAllSnapshots();
        const keys = Object.keys(all).sort((a,b) => all[b].ts - all[a].ts);
        if(keys.length){ applySnapshot(all[keys[0]]); }
      }

      // —— 编辑工具条按钮 ——（仅编辑端可用）
      const saveBtn = document.getElementById('save-site');
      const shareBtn = document.getElementById('share-site');
      if(isView){
        saveBtn.style.display='none';
        shareBtn.style.display='none';
      }else{
        // 1. 保存网站 (云端 POST 保存)
        saveBtn.addEventListener('click', async () => {
            syncFromDOM();
            const snap = createSnapshot();
            let sid;
            try {
                showToast('正在上传配置至云端...');
                sid = await postSnapshot(snap);
                history.replaceState(null, '', location.pathname + '?mode=edit&id=' + sid);
                showToast('已保存至云端，新快照ID：' + sid);
                // 也保存到本地作为备份
                const all = loadAllSnapshots(); all[sid]=snap; saveAllSnapshots(all);
            } catch (error) {
                console.error('Save failed:', error);
                showToast('保存失败: 无法连接到云服务或数据过大。请检查您的 API 配置。', 7000);
            }
        });

        // 2. 分享 (云端 POST + 复制链接)
        shareBtn.addEventListener('click', async () => {
            syncFromDOM();
            const snap = createSnapshot();
            let sid;
            try {
                showToast('正在上传配置，请稍候...');
                sid = await postSnapshot(snap);
                history.replaceState(null, '', location.pathname + '?mode=edit&id=' + sid);
                const url = location.origin + location.pathname + '?mode=view&id=' + sid;
                const ok = await copyText(url);
                if (ok) {
                    showToast('已成功保存至云端并复制分享链接！');
                } else {
                    const t = toastEl();
                    t.innerHTML = '复制失败（需手动）：请复制链接<br><input type="text" value="'+url+'" readonly style="width:100%; color:#333; background:#fef3c7; border:1px solid #d97706; padding:.25rem .5rem; border-radius:.25rem; margin-top:.5rem; font-size:.75rem;">';
                    t.style.backgroundColor = '#f59e0b';
                    t.style.display = 'block';
                    setTimeout(() => { t.style.display = 'none'; }, 8000);
                }
                // 本地备份
                const all = loadAllSnapshots(); all[sid]=snap; saveAllSnapshots(all);
            } catch (error) {
                console.error('Sharing failed:', error);
                showToast('分享失败: 无法连接到云服务或数据过大。请检查您的 API 配置。', 7000);
            }
        });
      }
    });

    // 绑定 modal 按钮与预览
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('manager-close-x').addEventListener('click',()=>closeManager(false));
      document.getElementById('manager-cancel').addEventListener('click',()=>closeManager(false));
      document.getElementById('manager-save').addEventListener('click',()=>closeManager(true));
      backdrop().addEventListener('click',(e)=>{ if(e.target===backdrop()) closeManager(false); });
      document.addEventListener('keydown',(e)=>{
        if(e.key==='Escape'){
          const m=document.getElementById('manager-backdrop');
          const p=document.getElementById('preview-backdrop');
          if(p.style.display==='flex') closePreview();
          else if(m.style.display==='flex') closeManager(false);
        }
      });
      document.getElementById('preview-close').addEventListener('click', closePreview);
      document.getElementById('preview-backdrop').addEventListener('click',(e)=>{ if(e.target.id==='preview-backdrop') closePreview(); });
    });

    // 暴露
    window.openManager=openManager;
  </script>

<script id="nav-active-hotfix">
// Minimal, non-breaking activation sync for sidebar tabs.
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var links = Array.from(document.querySelectorAll('.nav-link'));
    if(!links.length) return;

    function setActive(a){
      links.forEach(function(n){ n.classList.remove('active'); });
      if(a) a.classList.add('active');
    }

    links.forEach(function(a){
      a.addEventListener('click', function(){ setActive(a); }, { passive:true });
    });

    var sections = Array.from(document.querySelectorAll('section'));
    try{
      var obs = new IntersectionObserver(function(es){
        es.forEach(function(entry){
          if(entry.isIntersecting){
            var id = entry.target.id;
            var el = document.querySelector('.nav-link[href="#'+id+'"]');
            if(el) setActive(el);
          }
        });
      }, { threshold: 0.25, rootMargin: '0px 0px -35% 0px' });
      sections.forEach(function(s){ obs.observe(s); });
    }catch(e){
      window.addEventListener('hashchange', function(){
        var el = document.querySelector('.nav-link[href="'+location.hash+'"]');
        if(el) setActive(el);
      });
    }
  });
})();
</script>

</body>
</html>
